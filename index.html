<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma classe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        // Supprimer le warning Tailwind CDN de la console
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                return;
            }
            originalWarn.apply(console, args);
        };
    </script>
    <style>
        .active-section { 
            display: block !important; 
        }
        .sidebar-btn { 
            width: 100%;
            text-align: left;
            padding: 1rem;
            transition: background-color 0.15s ease-in-out;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgb(51, 65, 85);
            color: white;
            background: transparent;
            border-left: none;
            border-right: none;
            border-top: none;
            cursor: pointer;
        }
        .sidebar-btn:hover { 
            background-color: rgb(51, 65, 85); 
        }
        #whiteboard { 
            cursor: crosshair; 
            background-color: white; 
            border: 2px solid #cbd5e1; 
        }
    </style>
</head>
<body class="bg-slate-50 flex h-screen overflow-hidden text-slate-800 font-sans">

    <nav class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl">
        <div class="p-6 text-center border-b border-slate-700 bg-slate-800">
            <h1 class="text-xl font-bold text-blue-400">MA CLASSE PRO</h1>
            <p id="liveClock" class="font-mono text-sm mt-2 text-slate-400">--:--:--</p>
        </div>
        <div class="flex-1 overflow-y-auto">
            <button onclick="show('classes')" class="sidebar-btn"><i class="fas fa-users mr-3"></i> Classes & Appel</button>
            <button onclick="show('outils')" class="sidebar-btn"><i class="fas fa-stopwatch mr-3"></i> Temps & Outils</button>
            <button onclick="show('tableau')" class="sidebar-btn"><i class="fas fa-chalkboard mr-3"></i> Tableau Blanc</button>
            <button onclick="show('fichiers')" class="sidebar-btn"><i class="fas fa-copy mr-3"></i> Mes Documents</button>
            <button onclick="show('agenda')" class="sidebar-btn"><i class="fas fa-calendar-alt mr-3"></i> Agenda</button>
            <button onclick="show('messagerie')" class="sidebar-btn"><i class="fas fa-envelope mr-3"></i> Messagerie</button>
            <button onclick="show('eval_creator')" class="sidebar-btn"><i class="fas fa-pen-nib mr-3"></i> Cr√©er une √âval</button>
            <button onclick="show('faire_eval')" class="sidebar-btn"><i class="fas fa-pencil-alt mr-3"></i> Faire une √âval</button>
            <button onclick="show('notes')" class="sidebar-btn"><i class="fas fa-graduation-cap mr-3"></i> Notes & Corrig√©s</button>
            <button onclick="show('statistiques')" class="sidebar-btn"><i class="fas fa-chart-bar mr-3"></i> Statistiques</button>
        </div>
    </nav>

    <main class="flex-1 relative overflow-y-auto p-8">

        <section id="s-classes" class="hidden active-section">
            <h2 class="text-3xl font-bold mb-6">Gestion des Classes</h2>
            <div class="bg-white p-4 rounded-xl shadow mb-6 flex gap-4">
                <input id="newClassName" type="text" placeholder="Nom de la classe..." class="border p-2 rounded flex-1">
                <button onclick="addClass()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">+ Cr√©er</button>
            </div>
            
            <div id="classesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

            <div id="appelModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                <div class="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 id="modalTitle" class="text-2xl font-bold">Liste de classe</h3>
                        <button onclick="closeAppel()" class="text-slate-400 hover:text-red-500 text-2xl">&times;</button>
                    </div>
                    <div class="mb-4 flex gap-2">
                        <input id="newStudentName" type="text" placeholder="Nom de l'√©l√®ve..." class="border p-2 rounded flex-1">
                        <button onclick="addStudent()" class="bg-green-600 text-white px-4 py-2 rounded">Ajouter</button>
                    </div>
                    <p class="text-sm text-slate-500 mb-2 italic">Astuce : Cliquez sur le nom d'un √©l√®ve pour voir ses d√©tails et sa moyenne.</p>
                    <div id="studentsList" class="space-y-2 max-h-96 overflow-y-auto border-t pt-4"></div>
                    
                    <div class="mt-6 flex gap-3">
                        <button onclick="validateAttendance()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700">
                            <i class="fas fa-check-circle mr-2"></i> Valider l'appel
                        </button>
                        <button onclick="closeAppel()" class="bg-slate-200 text-slate-600 px-6 py-3 rounded-lg font-bold hover:bg-slate-300">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="s-student-details" class="hidden">
            <button onclick="show('classes'); openAppel(currentClassIdx)" class="mb-4 text-slate-500 hover:text-blue-600 font-bold flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Retour √† la liste
            </button>
            
            <div class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-indigo-500">
                <div class="flex justify-between items-start mb-8">
                    <div>
                        <h2 id="sd-name" class="text-4xl font-bold text-slate-800 mb-2">Nom de l'√©l√®ve</h2>
                        <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold">Fiche Individuelle</span>
                    </div>
                    <div class="text-right">
                        <p class="text-slate-500 font-bold uppercase text-xs tracking-wider">Moyenne G√©n√©rale</p>
                        <div id="sd-average" class="text-5xl font-bold text-indigo-600">--/20</div>
                    </div>
                </div>

                <h3 class="text-xl font-bold mb-4 border-b pb-2">Historique des notes</h3>
                <div class="overflow-hidden rounded-lg border border-slate-200 mb-8">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="p-4 font-bold text-slate-600">√âvaluation</th>
                                <th class="p-4 font-bold text-slate-600 text-right">Note</th>
                            </tr>
                        </thead>
                        <tbody id="sd-history-list" class="divide-y divide-slate-100">
                        </tbody>
                    </table>
                </div>

                <h3 class="text-xl font-bold mb-4 border-b pb-2 flex items-center gap-2">
                    <i class="fas fa-tasks text-orange-500"></i> Devoirs √† faire
                </h3>
                <div id="sd-homework-list" class="space-y-3">
                </div>
            </div>
        </section>

        <section id="s-outils" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Chronom√®tre & Minuteur</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-10 rounded-2xl shadow text-center border-b-8 border-green-500">
                    <h3 class="text-xl font-bold text-slate-400 mb-4">CHRONOM√àTRE</h3>
                    <div id="chronoDisplay" class="text-7xl font-mono mb-8">00:00:00</div>
                    <div class="flex justify-center gap-4">
                        <button id="btnStartChrono" onclick="startChrono()" class="bg-green-500 text-white px-8 py-3 rounded-full font-bold">START</button>
                        <button onclick="stopChrono()" class="bg-red-500 text-white px-8 py-3 rounded-full font-bold">STOP</button>
                        <button onclick="resetChrono()" class="bg-slate-200 text-slate-600 px-8 py-3 rounded-full font-bold">RESET</button>
                    </div>
                </div>
                <div class="bg-white p-10 rounded-2xl shadow text-center border-b-8 border-purple-500">
                    <h3 class="text-xl font-bold text-slate-400 mb-4">MINUTEUR</h3>
                    <div id="timerDisplay" class="text-7xl font-mono mb-8 text-purple-600">00:00</div>
                    <input id="timerInput" type="number" value="5" class="border p-2 rounded w-20 text-center mb-4 block mx-auto text-2xl">
                    <div class="flex justify-center gap-4">
                        <button id="btnStartTimer" onclick="startTimer()" class="bg-purple-600 text-white px-8 py-3 rounded-full font-bold">LANCER</button>
                        <button onclick="stopTimer()" class="bg-red-500 text-white px-8 py-3 rounded-full font-bold">STOP</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="s-fichiers" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Mes Documents</h2>
            <div class="bg-white p-6 rounded-xl shadow mb-8">
                <input id="docTitle" type="text" placeholder="Titre du document..." class="w-full border p-3 rounded mb-4 font-bold">
                <textarea id="docContent" rows="8" class="w-full border p-4 rounded mb-4" placeholder="Tapez votre contenu ici..."></textarea>
                <button onclick="saveDoc()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Enregistrer le fichier</button>
            </div>
            <div id="docsList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </section>

        <section id="s-agenda" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Agenda des Devoirs</h2>
            
            <!-- Formulaire pour ajouter un devoir -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 border-orange-500 mb-8">
                <h3 class="text-xl font-bold mb-4 text-orange-700">Donner un nouveau devoir</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Classe</label>
                        <select id="homeworkClassSelect" class="w-full border p-3 rounded">
                            <option value="">-- S√©lectionner une classe --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Date limite</label>
                        <input id="homeworkDate" type="date" class="w-full border p-3 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Description du devoir</label>
                        <textarea id="homeworkDescription" rows="4" class="w-full border p-3 rounded" placeholder="Ex: Exercices page 42, questions 1 √† 5"></textarea>
                    </div>
                    <button onclick="addHomework()" class="bg-orange-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-orange-700">
                        <i class="fas fa-plus mr-2"></i> Donner le devoir
                    </button>
                </div>
            </div>

            <!-- Liste des devoirs -->
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 class="text-xl font-bold mb-4 text-slate-700">Liste des devoirs donn√©s</h3>
                <div id="homeworkList" class="space-y-3">
                </div>
            </div>
        </section>

        <section id="s-tableau" class="hidden h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-3xl font-bold">Tableau Blanc</h2>
                <div class="bg-white p-2 rounded shadow flex gap-4">
                    <input type="color" id="penColor" class="w-10 h-10 cursor-pointer">
                    <button onclick="setTabMode('draw')" class="px-4 py-2 border rounded hover:bg-slate-100">Dessiner</button>
                    <button onclick="setTabMode('text')" class="px-4 py-2 border rounded hover:bg-slate-100">Texte (Clavier)</button>
                    <button onclick="clearTab()" class="px-4 py-2 bg-red-50 text-red-600 rounded">Tout effacer</button>
                </div>
            </div>
            <canvas id="whiteboard" width="1200" height="600" class="w-full h-[600px] rounded-xl shadow-inner"></canvas>
        </section>

        <section id="s-eval_creator" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Cr√©ateur d'√âvaluations</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 border-blue-500">
                <input id="newEvalTitle" type="text" placeholder="Nom de l'√©valuation (ex: Math√©matiques - Fractions)" class="w-full border p-3 rounded mb-4 font-bold text-xl text-blue-800">
                <div id="evalQuestionsList" class="space-y-4 mb-6"></div>
                <button onclick="addQuestionToEval()" class="bg-slate-100 border-2 border-dashed border-slate-300 w-full p-4 rounded text-slate-500 font-bold hover:bg-slate-50">+ Ajouter une question</button>
                <button onclick="saveEval()" class="mt-8 bg-green-600 text-white px-10 py-3 rounded-xl font-bold text-lg">Publier l'√©valuation</button>
            </div>
        </section>

        <section id="s-faire_eval" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Faire une √âvaluation</h2>
            
            <!-- Liste des √©valuations disponibles -->
            <div id="evalListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>

            <!-- Formulaire pour faire l'√©valuation -->
            <div id="evalFormContainer" class="hidden">
                <button onclick="backToEvalList()" class="mb-4 text-slate-500 hover:text-blue-600 font-bold flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Retour √† la liste
                </button>
                
                <div class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-purple-500">
                    <h3 id="currentEvalTitle" class="text-3xl font-bold text-purple-800 mb-6"></h3>
                    <div id="evalQuestionsContainer" class="space-y-6">
                    </div>
                    <div class="flex gap-4 mt-8">
                        <button onclick="saveMyAnswers()" class="bg-purple-600 text-white px-8 py-3 rounded-xl font-bold text-lg hover:bg-purple-700">
                            <i class="fas fa-save mr-2"></i> Enregistrer mes r√©ponses
                        </button>
                        <button onclick="viewMyCorrection()" class="bg-green-600 text-white px-8 py-3 rounded-xl font-bold text-lg hover:bg-green-700">
                            <i class="fas fa-check-circle mr-2"></i> Voir ma correction
                        </button>
                    </div>
                </div>
            </div>

            <!-- Correction -->
            <div id="evalCorrectionContainer" class="hidden">
                <button onclick="backToEvalForm()" class="mb-4 text-slate-500 hover:text-blue-600 font-bold flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Retour √† l'√©valuation
                </button>
                
                <div class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-green-500">
                    <h3 id="correctionEvalTitle" class="text-3xl font-bold text-green-800 mb-6"></h3>
                    <div id="evalCorrectionContent" class="space-y-6">
                    </div>
                </div>
            </div>
        </section>

        <section id="s-messagerie" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Messagerie</h2>
            
            <!-- Formulaire de message -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 border-cyan-500 mb-8">
                <h3 class="text-xl font-bold mb-4 text-cyan-700">Nouveau message</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Type de destinataire</label>
                        <select id="messageRecipientType" onchange="updateRecipientOptions()" class="w-full border p-3 rounded">
                            <option value="student">√âl√®ve</option>
                            <option value="parent">Parent d'√©l√®ve</option>
                            <option value="class">Classe enti√®re</option>
                        </select>
                    </div>
                    <div id="messageRecipientContainer">
                        <label class="block text-sm font-bold text-slate-600 mb-2">Destinataire</label>
                        <select id="messageRecipient" class="w-full border p-3 rounded">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Sujet</label>
                        <input id="messageSubject" type="text" class="w-full border p-3 rounded" placeholder="Objet du message">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-600 mb-2">Message</label>
                        <textarea id="messageContent" rows="6" class="w-full border p-3 rounded" placeholder="Votre message..."></textarea>
                    </div>
                    <button onclick="sendMessage()" class="bg-cyan-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-cyan-700">
                        <i class="fas fa-paper-plane mr-2"></i> Envoyer le message
                    </button>
                </div>
            </div>

            <!-- Liste des messages envoy√©s -->
            <div class="bg-white p-6 rounded-xl shadow">
                <h3 class="text-xl font-bold mb-4 text-slate-700">Messages envoy√©s</h3>
                <div id="messagesList" class="space-y-3">
                </div>
            </div>
        </section>

        <section id="s-statistiques" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Statistiques</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Statistiques g√©n√©rales -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-8 border-indigo-500">
                    <h3 class="text-xl font-bold mb-4 text-indigo-700 flex items-center gap-2">
                        <i class="fas fa-chart-pie"></i> Vue d'ensemble
                    </h3>
                    <div id="statsOverview" class="space-y-3">
                    </div>
                </div>

                <!-- S√©lecteur de classe -->
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-8 border-purple-500">
                    <h3 class="text-xl font-bold mb-4 text-purple-700 flex items-center gap-2">
                        <i class="fas fa-filter"></i> Filtrer par classe
                    </h3>
                    <select id="statsClassSelect" onchange="updateClassStats()" class="w-full border p-3 rounded mb-4">
                        <option value="">Toutes les classes</option>
                    </select>
                    <div id="statsClassDetails" class="space-y-3">
                    </div>
                </div>
            </div>

            <!-- Statistiques d'absences -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 border-red-500 mb-6">
                <h3 class="text-xl font-bold mb-4 text-red-700 flex items-center gap-2">
                    <i class="fas fa-user-times"></i> Absences
                </h3>
                <div id="statsAbsences">
                </div>
            </div>

            <!-- Statistiques de notes -->
            <div class="bg-white p-6 rounded-xl shadow-lg border-l-8 border-green-500">
                <h3 class="text-xl font-bold mb-4 text-green-700 flex items-center gap-2">
                    <i class="fas fa-graduation-cap"></i> Notes
                </h3>
                <div id="statsGrades">
                </div>
            </div>
        </section>

        <section id="s-notes" class="hidden">
            <h2 class="text-3xl font-bold mb-6">Saisie des Notes</h2>
            <div class="bg-white p-6 rounded-xl shadow">
                <p class="mb-4 text-slate-500 italic italic">S√©lectionnez une classe et une √©valuation pour saisir les notes.</p>
                <div class="flex gap-4 mb-6">
                    <select id="selectClassNote" onchange="renderGradesTable()" class="border p-2 rounded flex-1"></select>
                    <select id="selectEvalNote" onchange="renderGradesTable()" class="border p-2 rounded flex-1"></select>
                </div>
                <div id="gradesTableContainer" class="overflow-x-auto"></div>
            </div>
        </section>

    </main>

    <script>
        // --- DONNEES ---
        let db = JSON.parse(localStorage.getItem('prof_v3_db')) || {
            classes: [],
            docs: [],
            evals: [],
            homeworks: [],
            messages: [],
            attendanceHistory: []
        };
        
        // S'assurer que toutes les propri√©t√©s existent
        db.classes = db.classes || [];
        db.docs = db.docs || [];
        db.evals = db.evals || [];
        db.homeworks = db.homeworks || [];
        db.messages = db.messages || [];
        db.attendanceHistory = db.attendanceHistory || [];
        
        // V√©rifier et corriger la structure des classes existantes
        db.classes = db.classes.map(classe => ({
            name: classe.name || 'Sans nom',
            students: (classe.students || []).map(student => ({
                name: student.name || 'Sans nom',
                status: student.status || 'present',
                notes: student.notes || {}
            }))
        }));
        
        // V√©rifier et corriger la structure des √©valuations
        db.evals = db.evals.map(evaluation => ({
            title: evaluation.title || 'Sans titre',
            questions: evaluation.questions || [],
            teacherAnswers: evaluation.teacherAnswers || {}
        }));
        
        let currentClassIdx = null;
        let currentStudentIdx = null;
        let currentEvalIdx = null;
        let tabMode = 'draw';

        function sync() { 
            try {
                localStorage.setItem('prof_v3_db', JSON.stringify(db)); 
            } catch (error) {
                console.error("Erreur lors de la sauvegarde:", error);
                alert("Erreur lors de la sauvegarde des donn√©es. V√©rifiez l'espace de stockage disponible.");
            }
        }

        // --- NAVIGATION ---
        function show(target) {
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
            document.getElementById('s-' + target).classList.remove('hidden');
            if(target === 'classes') renderClasses();
            if(target === 'fichiers') renderDocs();
            if(target === 'notes') populateNotesFilters();
            if(target === 'agenda') renderAgenda();
            if(target === 'faire_eval') renderEvalList();
            if(target === 'messagerie') renderMessagerie();
            if(target === 'statistiques') renderStatistiques();
        }

        setInterval(() => {
            document.getElementById('liveClock').innerText = new Date().toLocaleTimeString('fr-FR');
        }, 1000);

        // --- CLASSES & APPEL ---
        function addClass() {
            let name = document.getElementById('newClassName').value;
            if(!name) return;
            db.classes.push({ name: name, students: [] });
            sync(); renderClasses();
            document.getElementById('newClassName').value = "";
        }

        function renderClasses() {
            const cont = document.getElementById('classesList');
            
            if (!cont) {
                console.error("√âl√©ment classesList non trouv√©");
                return;
            }
            
            if (!db.classes || db.classes.length === 0) {
                cont.innerHTML = '<p class="col-span-full text-slate-400 italic text-center p-8">Aucune classe cr√©√©e. Utilisez le formulaire ci-dessus pour cr√©er votre premi√®re classe.</p>';
                return;
            }
            
            cont.innerHTML = db.classes.map((c, i) => `
                <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-blue-500 hover:shadow-xl transition cursor-pointer">
                    <h3 onclick="openAppel(${i})" class="text-2xl font-bold text-blue-800 mb-4">${c.name || 'Sans nom'}</h3>
                    <p class="text-slate-500 mb-4">${(c.students || []).length} √©l√®ve(s)</p>
                    <div class="flex justify-between">
                        <button onclick="openAppel(${i})" class="bg-blue-100 text-blue-600 px-4 py-2 rounded font-bold">Appel / Liste</button>
                        <button onclick="deleteClass(${i})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function deleteClass(i) {
            if(confirm("Supprimer cette classe ?")) { db.classes.splice(i, 1); sync(); renderClasses(); }
        }

        function openAppel(i) {
            if (!db.classes[i]) {
                alert("Erreur: classe non trouv√©e");
                return;
            }
            
            currentClassIdx = i;
            document.getElementById('modalTitle').innerText = "Appel : " + (db.classes[i].name || "Sans nom");
            document.getElementById('appelModal').classList.remove('hidden');
            renderStudents();
        }

        function closeAppel() { document.getElementById('appelModal').classList.add('hidden'); }

        function addStudent() {
            let name = document.getElementById('newStudentName').value;
            if(!name || !name.trim()) return;
            
            // V√©rifier que currentClassIdx est valide
            if (currentClassIdx === null || !db.classes[currentClassIdx]) {
                alert("Erreur: classe non s√©lectionn√©e");
                return;
            }
            
            // Cr√©er l'√©l√®ve avec une structure compl√®te
            db.classes[currentClassIdx].students.push({ 
                name: name.trim(), 
                status: 'present', 
                notes: {} 
            });
            
            sync(); 
            renderStudents();
            document.getElementById('newStudentName').value = "";
        }

        function renderStudents() {
            const cont = document.getElementById('studentsList');
            
            if (!cont) {
                console.error("√âl√©ment studentsList non trouv√©");
                return;
            }
            
            if (currentClassIdx === null || !db.classes[currentClassIdx]) {
                cont.innerHTML = '<p class="text-slate-400 italic text-center p-4">Aucune classe s√©lectionn√©e.</p>';
                return;
            }
            
            const students = db.classes[currentClassIdx].students || [];
            
            if (students.length === 0) {
                cont.innerHTML = '<p class="text-slate-400 italic text-center p-4">Aucun √©l√®ve dans cette classe.</p>';
                return;
            }
            
            cont.innerHTML = students.map((s, i) => `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition">
                    <span onclick="openStudentDetails(${i})" class="font-bold text-lg cursor-pointer text-slate-700 hover:text-blue-600 hover:underline flex items-center gap-2" title="Voir fiche √©l√®ve">
                        <i class="fas fa-user-circle text-slate-400"></i> ${s.name || 'Sans nom'}
                    </span>
                    <div class="flex gap-2">
                        <button onclick="togglePresence(${i})" class="px-4 py-1 rounded-full font-bold text-xs ${s.status === 'present' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                            ${s.status === 'present' ? 'PR√âSENT' : 'ABSENT'}
                        </button>
                        <button onclick="removeStudent(${i})" class="text-red-300 ml-4"><i class="fas fa-user-minus"></i></button>
                    </div>
                </div>
            `).join('');
        }

        // --- DETAILS ELEVE ---
        function openStudentDetails(studentIndex) {
            try {
                closeAppel();
                currentStudentIdx = studentIndex;
                
                // V√©rifier que les donn√©es existent
                if (!db.classes[currentClassIdx] || !db.classes[currentClassIdx].students[studentIndex]) {
                    alert("Erreur: √©l√®ve introuvable");
                    return;
                }
                
                const student = db.classes[currentClassIdx].students[studentIndex];
                
                // Remplir le nom
                document.getElementById('sd-name').innerText = student.name || "√âl√®ve sans nom";

                // Calculer la moyenne et l'historique
                let total = 0;
                let count = 0;
                let historyHtml = "";

                // S'assurer que student.notes existe
                if (student.notes && typeof student.notes === 'object') {
                    for (const [evalTitle, grade] of Object.entries(student.notes)) {
                        let noteNum = parseFloat(grade);
                        
                        if(!isNaN(noteNum)) {
                            total += noteNum;
                            count++;
                        }

                        historyHtml += `
                            <tr class="hover:bg-slate-50">
                                <td class="p-4 text-slate-700">${evalTitle}</td>
                                <td class="p-4 font-bold text-right ${!isNaN(noteNum) && noteNum < 10 ? 'text-red-500' : 'text-green-600'}">
                                    ${grade}/20
                                </td>
                            </tr>
                        `;
                    }
                }

                // Calcul moyenne
                let average = count > 0 ? (total / count).toFixed(2) : "--";
                let colorClass = (average !== "--" && average < 10) ? "text-red-500" : "text-indigo-600";
                
                document.getElementById('sd-average').innerHTML = `<span class="${colorClass}">${average}</span><span class="text-2xl text-slate-400">/20</span>`;
                document.getElementById('sd-history-list').innerHTML = historyHtml || '<tr><td colspan="2" class="p-4 text-center text-slate-400">Aucune note enregistr√©e.</td></tr>';

                // Afficher les devoirs √† faire
                renderStudentHomework();

                // Afficher la section
                show('student-details');
            } catch (error) {
                console.error("Erreur lors de l'ouverture de la fiche √©l√®ve:", error);
                alert("Erreur lors de l'ouverture de la fiche √©l√®ve. V√©rifiez la console pour plus de d√©tails.");
            }
        }

        function renderStudentHomework() {
            try {
                if (!db.classes[currentClassIdx]) {
                    return;
                }
                
                const className = db.classes[currentClassIdx].name;
                const homeworkList = (db.homeworks || []).filter(hw => !hw.done && hw.className === className);
                
                const cont = document.getElementById('sd-homework-list');
                
                if (!cont) {
                    console.error("√âl√©ment sd-homework-list non trouv√©");
                    return;
                }
                
                if (homeworkList.length === 0) {
                    cont.innerHTML = '<p class="text-slate-400 italic">Aucun devoir en cours.</p>';
                } else {
                    cont.innerHTML = homeworkList.map(hw => `
                        <div class="p-4 bg-orange-50 border-l-4 border-orange-500 rounded">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-bold text-orange-700">Pour le ${hw.date || 'Date non d√©finie'}</span>
                            </div>
                            <p class="text-slate-700">${hw.description || 'Pas de description'}</p>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error("Erreur lors du rendu des devoirs:", error);
            }
        }

        function togglePresence(i) {
            let s = db.classes[currentClassIdx].students[i];
            s.status = s.status === 'present' ? 'absent' : 'present';
            sync(); renderStudents();
        }

        function removeStudent(i) {
            if(confirm("Supprimer cet √©l√®ve ?")) {
                db.classes[currentClassIdx].students.splice(i, 1);
                sync(); renderStudents();
            }
        }

        // --- VALIDATION DE L'APPEL ---
        function validateAttendance() {
            if (currentClassIdx === null || !db.classes[currentClassIdx]) {
                alert("Erreur: classe non s√©lectionn√©e");
                return;
            }

            const className = db.classes[currentClassIdx].name;
            const students = db.classes[currentClassIdx].students;
            const date = new Date().toLocaleDateString('fr-FR');
            
            // Compter les pr√©sents et absents
            let presentCount = 0;
            let absentCount = 0;
            const attendanceData = [];

            students.forEach(student => {
                if (student.status === 'present') {
                    presentCount++;
                } else {
                    absentCount++;
                }
                attendanceData.push({
                    name: student.name,
                    status: student.status
                });
            });

            // Sauvegarder dans l'historique
            db.attendanceHistory.push({
                className: className,
                date: date,
                timestamp: Date.now(),
                presentCount: presentCount,
                absentCount: absentCount,
                students: attendanceData
            });

            // R√©initialiser tous les statuts √† "present"
            db.classes[currentClassIdx].students.forEach(student => {
                student.status = 'present';
            });

            sync();
            renderStudents();
            
            alert(`Appel valid√© !\n\nPr√©sents: ${presentCount}\nAbsents: ${absentCount}\n\nLes statuts ont √©t√© r√©initialis√©s.`);
        }

        // --- AGENDA / DEVOIRS ---
        function renderAgenda() {
            // Remplir le select des classes
            const classSelect = document.getElementById('homeworkClassSelect');
            classSelect.innerHTML = '<option value="">-- S√©lectionner une classe --</option>' + 
                db.classes.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
            
            // Afficher la liste des devoirs
            renderHomeworkList();
        }

        function addHomework() {
            const classIdx = document.getElementById('homeworkClassSelect').value;
            const date = document.getElementById('homeworkDate').value;
            const description = document.getElementById('homeworkDescription').value;
            
            if(!classIdx || classIdx === "") {
                alert("Veuillez s√©lectionner une classe !");
                return;
            }
            if(!date) {
                alert("Veuillez s√©lectionner une date !");
                return;
            }
            if(!description) {
                alert("Veuillez entrer une description !");
                return;
            }
            
            const className = db.classes[classIdx].name;
            
            db.homeworks.push({
                className: className,
                date: date,
                description: description,
                done: false,
                id: Date.now()
            });
            
            sync();
            
            // R√©initialiser le formulaire
            document.getElementById('homeworkClassSelect').value = "";
            document.getElementById('homeworkDate').value = "";
            document.getElementById('homeworkDescription').value = "";
            
            renderHomeworkList();
            alert("Devoir ajout√© avec succ√®s !");
        }

        function renderHomeworkList() {
            const cont = document.getElementById('homeworkList');
            
            if (db.homeworks.length === 0) {
                cont.innerHTML = '<p class="text-slate-400 italic text-center py-8">Aucun devoir donn√© pour le moment.</p>';
                return;
            }
            
            cont.innerHTML = db.homeworks.map((hw, i) => `
                <div class="flex items-start gap-4 p-4 border rounded-lg ${hw.done ? 'bg-slate-50 opacity-60' : 'bg-white'}">
                    <input type="checkbox" ${hw.done ? 'checked' : ''} onchange="toggleHomework(${i})" class="mt-1 w-5 h-5 cursor-pointer">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-bold text-lg ${hw.done ? 'line-through text-slate-400' : 'text-slate-700'}">${hw.className}</span>
                            <span class="text-sm ${hw.done ? 'text-slate-400' : 'text-orange-600'} font-bold">üìÖ ${hw.date}</span>
                        </div>
                        <p class="${hw.done ? 'line-through text-slate-400' : 'text-slate-600'}">${hw.description}</p>
                    </div>
                </div>
            `).join('');
        }

        function toggleHomework(index) {
            const hw = db.homeworks[index];
            
            if (!hw.done) {
                // Marquer comme fait (le devoir sera supprim√©)
                if (confirm("Marquer ce devoir comme termin√© ? Il sera supprim√© de la liste.")) {
                    db.homeworks.splice(index, 1);
                    sync();
                    renderHomeworkList();
                }
            }
        }

        // --- DOCUMENTS ---
        function saveDoc() {
            let title = document.getElementById('docTitle').value;
            let content = document.getElementById('docContent').value;
            if(!title) return alert("Mettez un titre !");
            db.docs.push({ title, content, date: new Date().toLocaleDateString() });
            sync(); renderDocs();
            document.getElementById('docTitle').value = "";
            document.getElementById('docContent').value = "";
        }

        function renderDocs() {
            const cont = document.getElementById('docsList');
            cont.innerHTML = db.docs.map((d, i) => `
                <div class="bg-white p-4 rounded-lg shadow border border-slate-200">
                    <h4 class="font-bold border-b mb-2 pb-1 text-blue-700">${d.title}</h4>
                    <p class="text-sm text-slate-600 line-clamp-3 mb-4">${d.content}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-slate-400">${d.date}</span>
                        <div class="flex gap-2">
                             <button onclick="viewDoc(${i})" class="text-blue-500 hover:underline text-sm font-bold">Ouvrir</button>
                             <button onclick="deleteDoc(${i})" class="text-red-400"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function viewDoc(i) {
            const d = db.docs[i];
            document.getElementById('docTitle').value = d.title;
            document.getElementById('docContent').value = d.content;
            alert("Document charg√© dans l'√©diteur.");
        }

        function deleteDoc(i) { db.docs.splice(i,1); sync(); renderDocs(); }

        // --- TEMPS ---
        let chronoSec = 0;
        let chronoInt = null;
        function startChrono() {
            if(chronoInt) return;
            chronoInt = setInterval(() => {
                chronoSec++;
                let h = Math.floor(chronoSec/3600).toString().padStart(2,'0');
                let m = Math.floor((chronoSec%3600)/60).toString().padStart(2,'0');
                let s = (chronoSec%60).toString().padStart(2,'0');
                document.getElementById('chronoDisplay').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }
        function stopChrono() { clearInterval(chronoInt); chronoInt = null; }
        function resetChrono() { stopChrono(); chronoSec = 0; document.getElementById('chronoDisplay').innerText = "00:00:00"; }

        let timerInt = null;
        function startTimer() {
            let sec = document.getElementById('timerInput').value * 60;
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                if(sec <= 0) { clearInterval(timerInt); alert("DING ! Temps fini."); return; }
                sec--;
                let m = Math.floor(sec/60).toString().padStart(2,'0');
                let s = (sec%60).toString().padStart(2,'0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
            }, 1000);
        }
        function stopTimer() { clearInterval(timerInt); }

        // --- TABLEAU ---
        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        let painting = false;

        function setTabMode(m) { tabMode = m; }
        canvas.addEventListener('mousedown', (e) => {
            if(tabMode === 'draw') { painting = true; draw(e); }
            else {
                let text = prompt("Texte :");
                if(text) {
                    ctx.font = "30px Arial";
                    ctx.fillStyle = document.getElementById('penColor').value;
                    const r = canvas.getBoundingClientRect();
                    ctx.fillText(text, e.clientX - r.left, e.clientY - r.top);
                }
            }
        });
        canvas.addEventListener('mouseup', () => { painting = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', draw);

        function draw(e) {
            if(!painting || tabMode !== 'draw') return;
            ctx.lineWidth = 4; ctx.lineCap = 'round';
            ctx.strokeStyle = document.getElementById('penColor').value;
            const r = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
            ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
        }
        function clearTab() { ctx.clearRect(0,0,canvas.width, canvas.height); }

        // --- EVALUATIONS ---
        function addQuestionToEval() {
            const cont = document.getElementById('evalQuestionsList');
            const questionId = 'q-' + Date.now();
            cont.innerHTML += `
                <div class="p-4 bg-slate-50 border rounded q-item" id="${questionId}">
                    <div class="flex gap-4 mb-3">
                        <input type="text" placeholder="Question..." class="border p-2 rounded flex-1 q-text">
                        <select class="border p-2 rounded q-type" onchange="updateQuestionType('${questionId}')">
                            <option value="libre">R√©ponse libre</option>
                            <option value="qcm">QCM (choix multiples)</option>
                            <option value="trueFalse">Vrai/Faux</option>
                        </select>
                        <button onclick="removeQuestion('${questionId}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="q-options hidden">
                    </div>
                </div>
            `;
        }

        function removeQuestion(questionId) {
            const element = document.getElementById(questionId);
            if (element && confirm("Supprimer cette question ?")) {
                element.remove();
            }
        }

        function updateQuestionType(questionId) {
            const questionDiv = document.getElementById(questionId);
            const type = questionDiv.querySelector('.q-type').value;
            const optionsDiv = questionDiv.querySelector('.q-options');
            
            if (type === 'qcm') {
                optionsDiv.classList.remove('hidden');
                optionsDiv.innerHTML = `
                    <p class="text-sm font-bold text-slate-600 mb-2">Options de r√©ponse :</p>
                    <div class="space-y-2 mb-2 qcm-options">
                        <input type="text" placeholder="Option 1" class="border p-2 rounded w-full">
                        <input type="text" placeholder="Option 2" class="border p-2 rounded w-full">
                    </div>
                    <button onclick="addQCMOption('${questionId}')" class="text-sm text-blue-600 hover:underline">
                        + Ajouter une option
                    </button>
                `;
            } else if (type === 'trueFalse') {
                optionsDiv.classList.remove('hidden');
                optionsDiv.innerHTML = `
                    <p class="text-sm text-slate-500 italic">Les √©l√®ves devront choisir entre Vrai et Faux</p>
                `;
            } else {
                optionsDiv.classList.add('hidden');
                optionsDiv.innerHTML = '';
            }
        }

        function addQCMOption(questionId) {
            const questionDiv = document.getElementById(questionId);
            const optionsContainer = questionDiv.querySelector('.qcm-options');
            const optionCount = optionsContainer.querySelectorAll('input').length + 1;
            
            const newOption = document.createElement('input');
            newOption.type = 'text';
            newOption.placeholder = `Option ${optionCount}`;
            newOption.className = 'border p-2 rounded w-full';
            optionsContainer.appendChild(newOption);
        }

        function saveEval() {
            let title = document.getElementById('newEvalTitle').value;
            if(!title) return alert("Titre manquant !");
            
            let questions = [];
            document.querySelectorAll('.q-item').forEach(el => {
                const questionText = el.querySelector('.q-text').value;
                const type = el.querySelector('.q-type').value;
                
                const questionData = {
                    q: questionText,
                    type: type
                };
                
                // Si c'est un QCM, r√©cup√©rer les options
                if (type === 'qcm') {
                    const options = [];
                    el.querySelectorAll('.qcm-options input').forEach(opt => {
                        if (opt.value.trim()) {
                            options.push(opt.value.trim());
                        }
                    });
                    questionData.options = options;
                }
                
                questions.push(questionData);
            });
            
            if (questions.length === 0) {
                return alert("Ajoutez au moins une question !");
            }
            
            db.evals.push({ title, questions, teacherAnswers: {} });
            sync(); 
            alert("√âvaluation publi√©e !");
            document.getElementById('newEvalTitle').value = "";
            document.getElementById('evalQuestionsList').innerHTML = "";
        }

        // --- FAIRE UNE EVALUATION (PROFESSEUR) ---
        function renderEvalList() {
            const cont = document.getElementById('evalListContainer');
            
            // Afficher la liste, masquer le formulaire et la correction
            document.getElementById('evalListContainer').classList.remove('hidden');
            document.getElementById('evalFormContainer').classList.add('hidden');
            document.getElementById('evalCorrectionContainer').classList.add('hidden');
            
            if (!db.evals || db.evals.length === 0) {
                cont.innerHTML = '<p class="col-span-full text-slate-400 italic text-center p-8">Aucune √©valuation cr√©√©e. Cr√©ez d\'abord une √©valuation dans l\'onglet "Cr√©er une √âval".</p>';
                return;
            }
            
            cont.innerHTML = db.evals.map((e, i) => {
                const hasAnswers = e.teacherAnswers && Object.keys(e.teacherAnswers).length > 0;
                return `
                    <div class="bg-white p-6 rounded-2xl shadow-lg border-t-8 border-purple-500 hover:shadow-xl transition">
                        <h3 class="text-2xl font-bold text-purple-800 mb-4">${e.title || 'Sans titre'}</h3>
                        <p class="text-slate-500 mb-4">${(e.questions || []).length} question(s)</p>
                        <div class="flex flex-col gap-2">
                            <button onclick="startEval(${i})" class="bg-purple-600 text-white px-4 py-2 rounded font-bold hover:bg-purple-700">
                                ${hasAnswers ? 'Modifier mes r√©ponses' : 'Faire l\'√©valuation'}
                            </button>
                            ${hasAnswers ? `
                                <button onclick="viewEvalCorrection(${i})" class="bg-green-100 text-green-700 px-4 py-2 rounded font-bold hover:bg-green-200">
                                    Voir ma correction
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function startEval(evalIdx) {
            currentEvalIdx = evalIdx;
            const evaluation = db.evals[evalIdx];
            
            // Masquer la liste, afficher le formulaire
            document.getElementById('evalListContainer').classList.add('hidden');
            document.getElementById('evalFormContainer').classList.remove('hidden');
            document.getElementById('evalCorrectionContainer').classList.add('hidden');
            
            // Afficher le titre
            document.getElementById('currentEvalTitle').innerText = evaluation.title || 'Sans titre';
            
            // Afficher les questions
            const questionsContainer = document.getElementById('evalQuestionsContainer');
            questionsContainer.innerHTML = (evaluation.questions || []).map((q, qIdx) => {
                const savedAnswer = evaluation.teacherAnswers ? evaluation.teacherAnswers[qIdx] : '';
                
                if (q.type === 'qcm') {
                    // QCM avec cases √† cocher
                    const options = q.options || [];
                    const savedAnswers = savedAnswer ? savedAnswer.split(',') : [];
                    
                    return `
                        <div class="p-4 bg-slate-50 border-l-4 border-purple-500 rounded">
                            <p class="font-bold text-lg mb-3 text-slate-800">Question ${qIdx + 1}: ${q.q || 'Question sans texte'}</p>
                            <p class="text-sm text-slate-500 mb-3 italic">Cochez une ou plusieurs r√©ponses</p>
                            <div class="space-y-2" id="qcm-${qIdx}">
                                ${options.map((opt, optIdx) => `
                                    <label class="flex items-center gap-2 p-2 hover:bg-slate-100 rounded cursor-pointer">
                                        <input type="checkbox" value="${opt}" ${savedAnswers.includes(opt) ? 'checked' : ''} 
                                            class="w-4 h-4" onchange="updateQCMAnswer(${qIdx})">
                                        <span>${opt}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (q.type === 'trueFalse') {
                    // Vrai/Faux
                    return `
                        <div class="p-4 bg-slate-50 border-l-4 border-purple-500 rounded">
                            <p class="font-bold text-lg mb-3 text-slate-800">Question ${qIdx + 1}: ${q.q || 'Question sans texte'}</p>
                            <div class="flex gap-4" id="tf-${qIdx}">
                                <label class="flex items-center gap-2 p-3 bg-green-50 border-2 border-green-200 rounded cursor-pointer hover:bg-green-100 flex-1">
                                    <input type="radio" name="tf-${qIdx}" value="Vrai" ${savedAnswer === 'Vrai' ? 'checked' : ''} class="w-4 h-4">
                                    <span class="font-bold text-green-700">Vrai</span>
                                </label>
                                <label class="flex items-center gap-2 p-3 bg-red-50 border-2 border-red-200 rounded cursor-pointer hover:bg-red-100 flex-1">
                                    <input type="radio" name="tf-${qIdx}" value="Faux" ${savedAnswer === 'Faux' ? 'checked' : ''} class="w-4 h-4">
                                    <span class="font-bold text-red-700">Faux</span>
                                </label>
                            </div>
                        </div>
                    `;
                } else {
                    // R√©ponse libre
                    return `
                        <div class="p-4 bg-slate-50 border-l-4 border-purple-500 rounded">
                            <p class="font-bold text-lg mb-3 text-slate-800">Question ${qIdx + 1}: ${q.q || 'Question sans texte'}</p>
                            <textarea 
                                id="answer-${qIdx}" 
                                rows="4" 
                                class="w-full border p-3 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="Votre r√©ponse ici..."
                            >${savedAnswer || ''}</textarea>
                        </div>
                    `;
                }
            }).join('');
        }

        function updateQCMAnswer(qIdx) {
            // Cette fonction est appel√©e quand on coche/d√©coche une case dans un QCM
            // Elle ne fait rien de sp√©cial car la sauvegarde se fait lors du clic sur "Enregistrer"
        }

        function backToEvalList() {
            document.getElementById('evalListContainer').classList.remove('hidden');
            document.getElementById('evalFormContainer').classList.add('hidden');
            document.getElementById('evalCorrectionContainer').classList.add('hidden');
            renderEvalList();
        }

        function saveMyAnswers() {
            if (currentEvalIdx === null || !db.evals[currentEvalIdx]) {
                alert("Erreur: √©valuation non trouv√©e");
                return;
            }
            
            const evaluation = db.evals[currentEvalIdx];
            const answers = {};
            
            // R√©cup√©rer toutes les r√©ponses
            (evaluation.questions || []).forEach((q, qIdx) => {
                if (q.type === 'qcm') {
                    // R√©cup√©rer les cases coch√©es
                    const qcmDiv = document.getElementById(`qcm-${qIdx}`);
                    if (qcmDiv) {
                        const checked = Array.from(qcmDiv.querySelectorAll('input[type="checkbox"]:checked'))
                            .map(cb => cb.value);
                        answers[qIdx] = checked.join(', ');
                    }
                } else if (q.type === 'trueFalse') {
                    // R√©cup√©rer le radio bouton s√©lectionn√©
                    const selected = document.querySelector(`input[name="tf-${qIdx}"]:checked`);
                    if (selected) {
                        answers[qIdx] = selected.value;
                    }
                } else {
                    // R√©ponse libre
                    const answerField = document.getElementById(`answer-${qIdx}`);
                    if (answerField) {
                        answers[qIdx] = answerField.value;
                    }
                }
            });
            
            // Sauvegarder les r√©ponses
            db.evals[currentEvalIdx].teacherAnswers = answers;
            sync();
            
            alert("Vos r√©ponses ont √©t√© enregistr√©es avec succ√®s !");
        }

        function viewMyCorrection() {
            if (currentEvalIdx === null || !db.evals[currentEvalIdx]) {
                alert("Erreur: √©valuation non trouv√©e");
                return;
            }
            
            viewEvalCorrection(currentEvalIdx);
        }

        function viewEvalCorrection(evalIdx) {
            currentEvalIdx = evalIdx;
            const evaluation = db.evals[evalIdx];
            
            // Masquer tout sauf la correction
            document.getElementById('evalListContainer').classList.add('hidden');
            document.getElementById('evalFormContainer').classList.add('hidden');
            document.getElementById('evalCorrectionContainer').classList.remove('hidden');
            
            // Afficher le titre
            document.getElementById('correctionEvalTitle').innerText = evaluation.title || 'Sans titre';
            
            // Afficher les questions et r√©ponses
            const correctionContainer = document.getElementById('evalCorrectionContent');
            
            if (!evaluation.teacherAnswers || Object.keys(evaluation.teacherAnswers).length === 0) {
                correctionContainer.innerHTML = '<p class="text-slate-400 italic text-center p-8">Vous n\'avez pas encore r√©pondu √† cette √©valuation.</p>';
                return;
            }
            
            correctionContainer.innerHTML = (evaluation.questions || []).map((q, qIdx) => {
                const answer = evaluation.teacherAnswers[qIdx] || 'Pas de r√©ponse';
                return `
                    <div class="p-6 bg-green-50 border-l-4 border-green-500 rounded-lg">
                        <p class="font-bold text-xl mb-3 text-slate-800">Question ${qIdx + 1}: ${q.q || 'Question sans texte'}</p>
                        <div class="bg-white p-4 rounded border border-green-200">
                            <p class="text-sm font-bold text-green-700 mb-2">Votre r√©ponse:</p>
                            <p class="text-slate-700 whitespace-pre-wrap">${answer}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function backToEvalForm() {
            if (currentEvalIdx !== null) {
                startEval(currentEvalIdx);
            } else {
                backToEvalList();
            }
        }

        // --- MESSAGERIE ---
        function renderMessagerie() {
            updateRecipientOptions();
            renderMessagesList();
        }

        function updateRecipientOptions() {
            const type = document.getElementById('messageRecipientType').value;
            const recipientSelect = document.getElementById('messageRecipient');
            
            recipientSelect.innerHTML = '';
            
            if (type === 'class') {
                // Liste des classes
                db.classes.forEach((classe, idx) => {
                    const option = document.createElement('option');
                    option.value = `class-${idx}`;
                    option.textContent = classe.name;
                    recipientSelect.appendChild(option);
                });
            } else {
                // Liste des √©l√®ves de toutes les classes
                db.classes.forEach((classe, classIdx) => {
                    classe.students.forEach((student, studentIdx) => {
                        const option = document.createElement('option');
                        option.value = `student-${classIdx}-${studentIdx}`;
                        option.textContent = `${student.name} (${classe.name})`;
                        recipientSelect.appendChild(option);
                    });
                });
            }
        }

        function sendMessage() {
            const recipientType = document.getElementById('messageRecipientType').value;
            const recipient = document.getElementById('messageRecipient').value;
            const subject = document.getElementById('messageSubject').value;
            const content = document.getElementById('messageContent').value;
            
            if (!recipient) {
                alert("Veuillez s√©lectionner un destinataire !");
                return;
            }
            if (!subject) {
                alert("Veuillez entrer un sujet !");
                return;
            }
            if (!content) {
                alert("Veuillez entrer un message !");
                return;
            }
            
            // D√©terminer le nom du destinataire
            let recipientName = '';
            if (recipientType === 'class') {
                const classIdx = parseInt(recipient.split('-')[1]);
                recipientName = db.classes[classIdx].name;
            } else {
                const parts = recipient.split('-');
                const classIdx = parseInt(parts[1]);
                const studentIdx = parseInt(parts[2]);
                recipientName = db.classes[classIdx].students[studentIdx].name;
            }
            
            // Sauvegarder le message
            db.messages.push({
                id: Date.now(),
                date: new Date().toLocaleDateString('fr-FR'),
                time: new Date().toLocaleTimeString('fr-FR'),
                recipientType: recipientType,
                recipient: recipient,
                recipientName: recipientName,
                subject: subject,
                content: content
            });
            
            sync();
            
            // R√©initialiser le formulaire
            document.getElementById('messageSubject').value = '';
            document.getElementById('messageContent').value = '';
            
            renderMessagesList();
            alert("Message envoy√© avec succ√®s !");
        }

        function renderMessagesList() {
            const cont = document.getElementById('messagesList');
            
            if (db.messages.length === 0) {
                cont.innerHTML = '<p class="text-slate-400 italic text-center py-8">Aucun message envoy√©.</p>';
                return;
            }
            
            cont.innerHTML = db.messages.slice().reverse().map((msg, i) => {
                const realIdx = db.messages.length - 1 - i;
                const typeLabel = msg.recipientType === 'class' ? 'Classe' : 
                                 msg.recipientType === 'parent' ? 'Parent' : '√âl√®ve';
                
                return `
                    <div class="p-4 border rounded-lg bg-slate-50">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="inline-block bg-cyan-100 text-cyan-700 px-2 py-1 rounded text-xs font-bold mr-2">${typeLabel}</span>
                                <span class="font-bold text-slate-700">${msg.recipientName}</span>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-400">${msg.date} √† ${msg.time}</p>
                                <button onclick="deleteMessage(${realIdx})" class="text-red-400 hover:text-red-600 text-xs mt-1">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="font-bold text-slate-800 mb-1">${msg.subject}</p>
                        <p class="text-slate-600 text-sm">${msg.content}</p>
                    </div>
                `;
            }).join('');
        }

        function deleteMessage(idx) {
            if (confirm("Supprimer ce message ?")) {
                db.messages.splice(idx, 1);
                sync();
                renderMessagesList();
            }
        }

        // --- STATISTIQUES ---
        function renderStatistiques() {
            renderStatsOverview();
            populateStatsClassSelect();
            updateClassStats();
            renderStatsAbsences();
            renderStatsGrades();
        }

        function renderStatsOverview() {
            const cont = document.getElementById('statsOverview');
            
            const totalClasses = db.classes.length;
            const totalStudents = db.classes.reduce((sum, c) => sum + c.students.length, 0);
            const totalEvals = db.evals.length;
            const totalAttendance = db.attendanceHistory.length;
            
            cont.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-indigo-50 rounded">
                    <span class="font-bold text-slate-700">Classes</span>
                    <span class="text-2xl font-bold text-indigo-600">${totalClasses}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded">
                    <span class="font-bold text-slate-700">√âl√®ves</span>
                    <span class="text-2xl font-bold text-blue-600">${totalStudents}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-purple-50 rounded">
                    <span class="font-bold text-slate-700">√âvaluations</span>
                    <span class="text-2xl font-bold text-purple-600">${totalEvals}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-green-50 rounded">
                    <span class="font-bold text-slate-700">Appels valid√©s</span>
                    <span class="text-2xl font-bold text-green-600">${totalAttendance}</span>
                </div>
            `;
        }

        function populateStatsClassSelect() {
            const select = document.getElementById('statsClassSelect');
            select.innerHTML = '<option value="">Toutes les classes</option>';
            
            db.classes.forEach((classe, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = classe.name;
                select.appendChild(option);
            });
        }

        function updateClassStats() {
            const classIdx = document.getElementById('statsClassSelect').value;
            const cont = document.getElementById('statsClassDetails');
            
            if (classIdx === '') {
                cont.innerHTML = '<p class="text-slate-400 italic">S√©lectionnez une classe pour voir ses statistiques d√©taill√©es.</p>';
                return;
            }
            
            const classe = db.classes[classIdx];
            const studentCount = classe.students.length;
            
            // Calculer la moyenne de la classe
            let totalGrades = 0;
            let gradeCount = 0;
            
            classe.students.forEach(student => {
                Object.values(student.notes).forEach(grade => {
                    const numGrade = parseFloat(grade);
                    if (!isNaN(numGrade)) {
                        totalGrades += numGrade;
                        gradeCount++;
                    }
                });
            });
            
            const classAverage = gradeCount > 0 ? (totalGrades / gradeCount).toFixed(2) : '--';
            
            // Compter les appels pour cette classe
            const attendanceCount = db.attendanceHistory.filter(a => a.className === classe.name).length;
            
            cont.innerHTML = `
                <div class="flex justify-between items-center p-3 bg-purple-50 rounded">
                    <span class="font-bold text-slate-700">√âl√®ves</span>
                    <span class="text-2xl font-bold text-purple-600">${studentCount}</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-green-50 rounded">
                    <span class="font-bold text-slate-700">Moyenne</span>
                    <span class="text-2xl font-bold text-green-600">${classAverage}/20</span>
                </div>
                <div class="flex justify-between items-center p-3 bg-blue-50 rounded">
                    <span class="font-bold text-slate-700">Appels</span>
                    <span class="text-2xl font-bold text-blue-600">${attendanceCount}</span>
                </div>
            `;
        }

        function renderStatsAbsences() {
            const cont = document.getElementById('statsAbsences');
            
            if (db.attendanceHistory.length === 0) {
                cont.innerHTML = '<p class="text-slate-400 italic">Aucun appel valid√©. Validez des appels pour voir les statistiques d\'absence.</p>';
                return;
            }
            
            // Compter les absences par √©l√®ve
            const absencesByStudent = {};
            
            db.attendanceHistory.forEach(attendance => {
                attendance.students.forEach(student => {
                    if (student.status === 'absent') {
                        const key = `${attendance.className} - ${student.name}`;
                        absencesByStudent[key] = (absencesByStudent[key] || 0) + 1;
                    }
                });
            });
            
            // Trier par nombre d'absences
            const sorted = Object.entries(absencesByStudent)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (sorted.length === 0) {
                cont.innerHTML = '<p class="text-green-600 font-bold">Aucune absence enregistr√©e ! üéâ</p>';
                return;
            }
            
            cont.innerHTML = `
                <table class="w-full">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="p-3 text-left font-bold">√âl√®ve</th>
                            <th class="p-3 text-right font-bold">Absences</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        ${sorted.map(([student, count]) => `
                            <tr>
                                <td class="p-3">${student}</td>
                                <td class="p-3 text-right font-bold text-red-600">${count}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderStatsGrades() {
            const cont = document.getElementById('statsGrades');
            
            // Calculer les moyennes de tous les √©l√®ves
            const studentAverages = [];
            
            db.classes.forEach(classe => {
                classe.students.forEach(student => {
                    let total = 0;
                    let count = 0;
                    
                    Object.values(student.notes).forEach(grade => {
                        const numGrade = parseFloat(grade);
                        if (!isNaN(numGrade)) {
                            total += numGrade;
                            count++;
                        }
                    });
                    
                    if (count > 0) {
                        const average = (total / count).toFixed(2);
                        studentAverages.push({
                            name: student.name,
                            className: classe.name,
                            average: parseFloat(average),
                            noteCount: count
                        });
                    }
                });
            });
            
            if (studentAverages.length === 0) {
                cont.innerHTML = '<p class="text-slate-400 italic">Aucune note enregistr√©e.</p>';
                return;
            }
            
            // Trier par moyenne d√©croissante
            studentAverages.sort((a, b) => b.average - a.average);
            
            // Top 10
            const top10 = studentAverages.slice(0, 10);
            
            // Moyenne g√©n√©rale
            const generalAverage = (studentAverages.reduce((sum, s) => sum + s.average, 0) / studentAverages.length).toFixed(2);
            
            cont.innerHTML = `
                <div class="mb-6 p-4 bg-green-50 rounded-lg">
                    <p class="text-lg"><span class="font-bold">Moyenne g√©n√©rale:</span> <span class="text-2xl font-bold text-green-700">${generalAverage}/20</span></p>
                    <p class="text-sm text-slate-600 mt-1">${studentAverages.length} √©l√®ve(s) avec au moins une note</p>
                </div>
                
                <h4 class="font-bold mb-3">üèÜ Top 10 des meilleurs √©l√®ves</h4>
                <table class="w-full">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="p-3 text-left font-bold">Rang</th>
                            <th class="p-3 text-left font-bold">√âl√®ve</th>
                            <th class="p-3 text-left font-bold">Classe</th>
                            <th class="p-3 text-right font-bold">Moyenne</th>
                            <th class="p-3 text-right font-bold">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        ${top10.map((student, idx) => `
                            <tr class="${idx === 0 ? 'bg-yellow-50' : ''}">
                                <td class="p-3 font-bold">${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : (idx + 1)}</td>
                                <td class="p-3 font-bold">${student.name}</td>
                                <td class="p-3 text-slate-600">${student.className}</td>
                                <td class="p-3 text-right font-bold text-green-600">${student.average}/20</td>
                                <td class="p-3 text-right text-slate-500">${student.noteCount}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // --- NOTES ---
        function populateNotesFilters() {
            const cSel = document.getElementById('selectClassNote');
            const eSel = document.getElementById('selectEvalNote');
            cSel.innerHTML = db.classes.map((c,i) => `<option value="${i}">${c.name}</option>`).join('');
            eSel.innerHTML = db.evals.map((e,i) => `<option value="${i}">${e.title}</option>`).join('');
            renderGradesTable();
        }

        function renderGradesTable() {
            const cI = document.getElementById('selectClassNote').value;
            const eI = document.getElementById('selectEvalNote').value;
            if(!db.classes[cI] || !db.evals[eI]) return;

            const students = db.classes[cI].students;
            const evalTitle = db.evals[eI].title;

            let html = `<table class="w-full text-left border-collapse">
                <thead><tr class="bg-slate-800 text-white">
                    <th class="p-3">√âl√®ve</th><th class="p-3">Note / 20</th>
                </tr></thead><tbody>`;
            
            students.forEach((s, sI) => {
                let val = s.notes[evalTitle] || "";
                html += `<tr class="border-b">
                    <td class="p-3 font-bold">${s.name}</td>
                    <td class="p-3"><input type="number" onchange="updateGrade(${cI}, ${sI}, '${evalTitle}', this.value)" value="${val}" class="border p-2 w-24 rounded"></td>
                </tr>`;
            });
            html += "</tbody></table>";
            document.getElementById('gradesTableContainer').innerHTML = html;
        }

        function updateGrade(cI, sI, evalTitle, val) {
            db.classes[cI].students[sI].notes[evalTitle] = val;
            sync();
        }

        // INIT
        renderClasses();
    </script>
</body>
</html>
